"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[164],{91164:function(t,e,r){r.r(e),r.d(e,{default:function(){return k}});var a=r(25541),i=r(12789),n=r(54798),s=r(68403),o=r(64669),l=r(98894),u=r(50903);class d{static getExitstance(){return d.instance}static getInstance(t,e){return d.instance||(d.instance=new d(t,e)),d.instance.setSize(t,e),d.instance}setSize(t,e){this.width=t,this.height=e}goBack(){if(0===this.currentIndex)return;let t=this.currentIndex-1;return this.currentIndex=t,this.list[t]}goForward(){if(this.currentIndex===this.list.length-1)return;let t=this.currentIndex+1;return this.currentIndex=t,this.list[t]}goTo(t){}addToHistory(t){if(console.log("addToHistory",this.list.length),0===this.list.length){if(Array.isArray(t))this.list.push();else if(t instanceof ArrayBuffer){let e=new ArrayBuffer(t.byteLength);this.list.push(e),this.currentIndex=0}else if(t instanceof HTMLCanvasElement){let t=(0,o.vL)(this.width,this.height);this.list.push(t),this.currentIndex=0}else if(t.canvas&&t.canvas instanceof HTMLCanvasElement){let e=(0,o.vL)(this.width,this.height);this.list.push({canvas:e,time:t.time}),this.currentIndex=0}}if(this.currentIndex===this.list.length-1)this.list.push(t),this.currentIndex=this.list.length-1;else{let e=this.list.slice(0,this.currentIndex+1);e.push(t),this.list=e,this.currentIndex=e.length-1}if(this.list.length>50){let t=this.list.length-50;this.list.splice(1,t)}}clearHistory(){this.list=[],this.currentIndex=-1}current(){return this.list[this.currentIndex]}get length(){return this.list.length}dispose(){this.list=[],this.currentIndex=0}constructor(t,e){this.list=[],this.currentIndex=0,this.width=t,this.height=e}}var h=r(50435),c=r(33833);class g{static getInstance(){return this.instance||(this.instance=new g),this.instance}add(t){let e=URL.createObjectURL(t);return this.list.push(e),this.blobList.push(t),e}release(){this.list.forEach(t=>{URL.revokeObjectURL(t)}),this.blobList=[],this.list=[]}constructor(){this.blobList=[],this.list=[]}}g.instance=void 0;var f=r(37653),m=r(37006),w=r(35537),p=r.n(w),v=r(30398);let b=()=>v.u.getState();var _=r(83076),U=r(17797),y=r(50839),R=r(27747),S=r(79498);let I=(0,m.Ue)((t,e)=>({frameId:"",setFrameId:e=>{t({frameId:e})},originalPreviewUrl:"",showResult:!1,setShowResult:e=>{t(t=>({...t,showResult:e}))},objectRemoverOption:{isRestore:!0,brushSize:50},frames:[],setObjectRemoverOption:e=>{t(t=>({...t,objectRemoverOption:{...t.objectRemoverOption,...e}}))},setFrame(e,r){t(t=>{let a=t.frames.findIndex(t=>t.id===e);return -1!==a&&(t.frames[a]={...t.frames[a],...r}),t})},leftCount:{total:0,used:0,remaining:0},startRemoveObjectTask:async(r,l)=>{var d,h;let c=b(),{setUploadBgProgress:g,setTaskInfo:m,setCreateTaskProgress:w,setGenerateProgress:p,setDownloadProgress:U,setGeneratingVisible:I,setState:k,setStatus:M,setTaskFailedModalVisible:P,setTaskFailedReason:L,resultUrl:F,fullResultUrl:x,taskId:j}=c,C=l&&"lock"===l.from,E=null!==(d=null==l?void 0:l.isDownload)&&void 0!==d&&d,{timeToFrame:O}=e();w(0),p(0),U(0),k({stopTag:!1});let T=R.c.getState(),q=T.originUrl,D="preview"===r,H="full"===r;if(!q)return Promise.reject("no originUrl");if(E){if(k({downloadLoading:!0}),D&&F)return Promise.resolve(F);if(H&&x)return Promise.resolve(x)}if(C){if(x)return t({originalPreviewUrl:""}),k({loading:!1,downloadLoading:!1,status:f.qb.Full,unlock:!0,transparentResiltUrl:x}),Promise.resolve(x);k({loading:!1,downloadLoading:!1,status:f.qb.Full,unlock:!0})}let N=await e().getMaskFile(),z=N.map(t=>t.blob).filter(t=>t),A=N.map(t=>t.uploadUrl).filter(t=>t);if(0===z.length&&0===A.length){(0,s.MessageWarn)(null===(h=_.ag)||void 0===h?void 0:h.t("object_error_mask_not_empty"));return}if(k({loading:!0}),I(!0),"preview"===r){for await(let t of N)if(t.frameStart=Math.floor(e().timeToFrame(t.time)),t.blob&&!t.uploadUrl){let e=URL.createObjectURL(t.blob),r=await (0,o.Rn)(e);if(r.width>t.width){let a=(0,o.YQ)(r,t.width,t.height);t.blob=await (0,o._c)(a,"image/png"),URL.revokeObjectURL(e)}let a=new File([t.blob],"mask.png",{type:"image/png"});try{let e=await R.c.getState().uploadFilePure(a,g);t.uploadUrl=e}catch(t){k({loading:!0}),I(!1);return}}}e().setFrames(N);let G=N.map(t=>t.frameStart),W=Math.min(...G),Z=y.E.getState(),B=Z.videoInfo.Duration;if(!R.c.getState().originUrl)return;let J={taskId:D?"":j,frameStart:Math.max(W,0),sourceVideo:R.c.getState().originUrl,videoTime:Math.ceil(B),maskSections:N.map(t=>{let r=Math.max(t.frameStart,0),a=e().timeToFrame(1e3*B);return{frameStart:Math.max(t.frameStart,0),frameEnd:Math.max(a,r),sourceMask:t.uploadUrl+""}})},Q={taskId:D?"":j,frameStart:Math.max(W,0),sourceVideo:R.c.getState().originUrl,videoTime:Math.ceil(B),maskSections:N.map(t=>({frameStart:0,frameEnd:e().timeToFrameMs(t.time)-t.frameStart,sourceMask:t.uploadUrl+""}))},V=D?n.fl:n.y9,{actionCreateTask:X,actionGenerateResult:Y,actionDownloadResult:$}=i.m3.getState(),K="preview"===r?"free":"hd",tt=new a.f({startApi:()=>V(D?Q:J).then(t=>{var e,r;if("000"===t.code){if(X(!0,"",K),w(100),t.data){let{taskId:e,originalVideoPreViewUrl:r,waitTime:a}=t.data;a>0&&tt.setLoopTimes(Math.max(a/2e3,180)),k({taskId:e}),m(t.data)}return H?k({hasPay:!0}):k({hasPay:!1,unlock:!1}),t}I(!1);let a=null!==(r=null==t?void 0:t.code)&&void 0!==r?r:"-1";(0,s.MessageError)(null===(e=_.ag)||void 0===e?void 0:e.t(u.uy[a]||"error_task_error"));let i="504"===a||"510"===a;if(M(i?f.qb.NoPreviewCount:f.qb.Default),"510"===a&&l&&l.callback&&l.callback(t),k({loading:!1,downloadLoading:!1}),i){let t="no_preview_count:code:".concat(a);return X(!1,t,K),Promise.reject(t)}let n="task_error:code:".concat(a,",msg:").concat(t.msg,",data:").concat(JSON.stringify(t.data));return X(!1,n,K),Promise.reject(n)}).catch(t=>{var e,r,a;if(I(!1),null==t?void 0:t.response){let i=null===(e=t.response)||void 0===e?void 0:e.status,n=null===(r=t.response)||void 0===r?void 0:r.data;X(!1,"start_task_catch_status:".concat(i,"_data:").concat(JSON.stringify(n)),K),(0,s.MessageError)(null===(a=_.ag)||void 0===a?void 0:a.t(u.uy["114"]))}return Promise.reject(t)}),pendingApi:t=>(0,n.ZJ)(t).catch(t=>{if(t.response){var e,r,a;let i=null===(e=t.response)||void 0===e?void 0:e.status,n=null===(r=t.response)||void 0===r?void 0:r.data;Y(!1,"result_pending_error_status:".concat(i,"_data:").concat(JSON.stringify(n)),K,{resource_id:b().taskId}),(0,s.MessageError)(null===(a=_.ag)||void 0===a?void 0:a.t(u.uy["114"]))}return Promise.reject(t)}),needStop:()=>v.u.getState().stopTag,continueCondition:(t,e)=>{if(!t.data)return!1;let a=v.u.getState(),{taskInfo:i}=a,{waitTime:n}=i;return(p("number"==typeof n&&n>0?Math.min(2e5*e/n,99):Math.min(Math.round(e/180*100),99)),"preview"===r)?0===t.data.status_preview:0===t.data.status}});return tt.start().then(e=>{if(e&&e.data){let r=e.data,{status:a,videoUrl:i,video_preview_url:n,status_preview:s,originalVideoPreViewUrl:o}=r;I(!1);let l=t=>{L(_.ag.t("error_task_error")),P(!0),I(!1),Y(!1,"result_status_".concat(t,"_error"),K,{resource_id:tt.taskId}),k({status:f.qb.Default,loading:!1,downloadLoading:!1})};if(D){if(1===s)return k({resultUrl:n,transparentResiltUrl:n,status:f.qb.Preview}),Y(!0,"",K),t({originalPreviewUrl:o}),C&&(t({originalPreviewUrl:""}),k({transparentResiltUrl:n})),t({showResult:!0}),k({isHandled:!0}),n;l(s)}else{if(1===a)return Y(!0,"",K),b().status!==f.qb.NoPreviewCount&&k({status:f.qb.Full}),k({hasPay:!0,fullResultUrl:i}),C&&(t({originalPreviewUrl:""}),k({transparentResiltUrl:i,unlock:!0})),S.Z.getState().getUserCredits(),i;l(a)}}else Y(!1,"result_gen_error:code:".concat(null==e?void 0:e.code,":msg:").concat(null==e?void 0:e.msg,":res:").concat(JSON.stringify(e)),K,{resource_id:b().taskId})}).catch(t=>{console.error(t),t===a.g.timeout?(L(_.ag.t("generating_task_timeout")),P(!0)):t===a.g.networkError&&(L(_.ag.t("network_error")),P(!0)),I(!1);let{status:e}=b();e===f.qb.GeneratingPreview?M(f.qb.Default):e===f.qb.GeneratingFull&&M(f.qb.Preview),E&&$({action_type:K,is_success:!1,fail_reason:i.z5.GENERATE_ERROE})}).finally(()=>{k({loading:!1}),E||(k({loading:!1,downloadLoading:!1}),g(100),w(100),p(100))})},getMaskFile:async()=>{let t=e().frames.slice(0);for(let r of t)if(!r.blob){let t=await e().getMaskFileByFrame(r);r.blob=t||void 0}return[...t]},getMaskFileByFrame:async t=>{let e=t.history.current();if(!e)return null;let r=(0,o.C9)(e.canvas);if(r)return null;let a=(0,o.hN)(e.canvas);return a},timeToFrame:t=>{let e=y.E.getState(),r=e.videoInfo.FrameRate;return Math.floor(t*Math.round(r)/1e3)},timeToFrameMs:t=>{let e=y.E.getState(),r=e.videoInfo.FrameRate,a=Math.round(r),i=Math.floor(t*a/1e3)+3*a,n=Math.floor(e.videoInfo.Duration*a);return i>n?n:i},setFrames:e=>{t({frames:e})},cutFranesLoading:!1,cutFrames:[],setCutUrl:(e,r)=>{t(t=>{let a=t.cutFrames.map(t=>(t.id===e&&(t.dataURL=r),t));return{cutFrames:a}})},setCutFrames:e=>{t({cutFrames:e})},startCutFrames:()=>{let r=R.c.getState(),a=r.file,i=y.E.getState(),n=i.videoInfo,s=i.isMobile,u=window.innerWidth,h=s?u:u-180-320-60-24-42,{Width:f,Height:m,FrameRate:w,Duration:b,Rotation:_}=n;console.log("videoInfo",n);let U=parseInt(_),{width:S,height:I}=(0,o.Zo)(f,m,U);v.u.getState().setWidthHeight(S,I);let k=S/I,M=56*k,P=[],L=Math.max(Math.floor(h/M),11)-1,F=1e3*b/L;t({cutFranesLoading:!0});for(let t=0;t<L;t++){let e={blob:void 0,id:p()(),width:M,height:Math.floor(56),time:t*F,dataURL:""};P.push(e)}let{setCutFrames:x,setCutUrl:j}=e();x(P),0===e().frames.length&&e().setFrames([{id:p()(),width:S,height:I,time:-1,frameStart:-1,history:new d(S,I)}]);let C=new c.Z(s?2:(0,l.hb)(),()=>{if(P.length>0){let[t]=P,{setFirstFrame:r}=v.u.getState();(0,o.dH)(t.dataURL,f,m,U).then(a=>{let i=g.getInstance().add(a);r(i),t.dataURL=i,e().setCutFrames([...P])})}t({cutFranesLoading:!1})});P.forEach((t,e)=>{C.add({type:t.id,task:()=>(0,l.ve)((0,l.bP)("js","web-capture.js"),"webCapture").then(e=>new Promise(r=>{console.log("frame.time",Math.floor(t.time)),e.capture(a,Math.floor(t.time),(e,a)=>{t.dataURL=e,r(e)})})).then(t=>0===e?null:(0,o.dH)(t,2*M,112,U)).then(e=>{if(!e)return;let r=g.getInstance().add(e);return t.dataURL=r,x([...P]),r}).catch(t=>{console.log("error",t)})})})},resetObject:()=>{t({showResult:!1,cutFranesLoading:!1,objectRemoverOption:{isRestore:!0,brushSize:50}});let e=v.u.getState(),{entry:r}=e;r===h.hZ.ObjectRemover&&v.u.setState({unlock:!1,downloadLoading:!1,hasPay:!1,fullResultUrl:"",resultUrl:"",transparentResiltUrl:"",transparentFull:"",taskId:"",status:f.qb.Default,taskInfo:{}})},resetAllObject:()=>{e().resetObject();let{cutFrames:r}=e();r.map(t=>t.dataURL),r.length>0&&r.forEach(t=>{t.dataURL=""}),t({frames:[],cutFrames:[]}),setTimeout(()=>{g.getInstance().release()},500)},async getHistory(){var r,a,o;let u=await (0,n.Fp)();if(!u){(0,s.MessageWarn)(null===(r=_.ag)||void 0===r?void 0:r.t("feature_banner_no_video"));return}if("000"!==u.code){(0,s.MessageWarn)(null===(a=_.ag)||void 0===a?void 0:a.t("feature_banner_no_video"));return}if(!u.data){(0,s.MessageWarn)(null===(o=_.ag)||void 0===o?void 0:o.t("feature_banner_no_video"));return}let{status_preview:h,status:c,videoUrl:g,fullMaskSections:m,preMaskSections:w,previewFrameStart:b}=u.data,U=!m,S=U?0===h:0===c,I=U?1===h:1===c,k=v.u.getState(),{setIsHandled:M,setState:P,entry:L,download:F}=k;if(m){let[e]=m,{frameStart:r,sourceMask:a}=e;t({frames:[{id:p()(),time:-1,frameStart:r,history:new d(0,0),width:0,height:0,blob:void 0,uploadUrl:a}]})}else if(w){let[e]=w,{sourceMask:r}=e;t({frames:[{id:p()(),time:-1,frameStart:b,history:new d(0,0),width:0,height:0,blob:void 0,uploadUrl:r}]})}if(S||I){if(t({cutFranesLoading:!0}),P({showContent:!0}),I){M(!0),t({showResult:!0});let{taskId:r,videoUrl:a,video_preview_url:i,originalVideoUrl:n,originalVideoPreViewUrl:s,preMaskSections:o,fullMaskSections:d,previewFrameStart:c}=u.data,g=!!a;if(P({resultUrl:i,fullResultUrl:a,transparentResiltUrl:a||i,taskId:r,taskInfo:u.data,status:i?f.qb.Preview:f.qb.Full,unlock:g,hasPay:g}),i&&(P({status:f.qb.Preview}),t({showResult:!0}),M(!0)),g&&P({status:f.qb.Full}),t({originalPreviewUrl:g?"":1===h?s:""}),R.c.setState({originUrl:n,localUrl:n}),n){P({showContent:!0});let r=await fetch(n).then(t=>t.blob()),a=new File([r],"origin.mp4",{type:r.type});R.c.setState({file:a});let i=await (0,l.$p)(a);y.E.setState({videoInfo:i});let{Width:s,Height:o,Duration:u,FrameRate:d}=i,h=e().frames;h.forEach(t=>{t.width=s,t.height=o,t.history.setSize(s,o),t.time=t.frameStart/d*1e3});for(let t=0;t<h.length;t++)await e().loadImageMask(h[t],d);t({frames:h}),e().startCutFrames()}(a||i)&&(t({showResult:!0}),M(!0))}else if(S){let{taskId:r,videoUrl:a,video_preview_url:n,originalVideoUrl:s,originalVideoPreViewUrl:o}=u.data;if(P({resultUrl:0===c?a:"",fullResultUrl:0===c?a:"",transparentResiltUrl:1===h?n:"",taskId:r,taskInfo:u.data,unlock:!1,hasPay:!!a}),R.c.setState({originUrl:s,localUrl:s}),0===c&&(M(!0),t({showResult:!0})),t({originalPreviewUrl:U&&1===h?o:""}),R.c.setState({originUrl:s,localUrl:s}),s){P({showContent:!0});let r=await fetch(s).then(t=>t.blob()),a=new File([r],"origin.mp4",{type:r.type});R.c.setState({file:a});let i=await (0,l.$p)(a);y.E.setState({videoInfo:i});let{Width:n,Height:o,Duration:u,FrameRate:d}=i,h=e().frames;h.forEach(t=>{t.width=n,t.height=o,t.history.setSize(n,o),t.time=t.frameStart/d*1e3});for(let t=0;t<h.length;t++)await e().loadImageMask(h[t],d);t({frames:h}),e().startCutFrames()}let{actionDownloadResult:d}=i.m3.getState(),g=localStorage.getItem("zustand_from_download")===String(!0);return e().continueObjectHistory(u.data).then(t=>{if(t&&g){let e=(0,l.UO)(L,"full",localStorage.getItem("zustand_download_video_type"));F(t,e);let r="preview";0!==h&&(0===c||1==c||2===c)&&(r="full");let a="preview"==r;d({action_type:a?"free":"hd",is_success:!0,fail_reason:""})}}).catch(t=>{g&&d({action_type:"hd",is_success:!1,fail_reason:t})})}}},continueObjectHistory:e=>{let{taskId:r,videoUrl:s,originalVideoUrl:o,status:l,status_preview:u,originalVideoPreViewUrl:d,fullMaskSections:h,video_preview_url:c}=e,g=Number(localStorage.getItem("zustand_objectremover_loop_times"))||0,m=v.u.getState(),{setGeneratingVisible:w,setUploadBgProgress:p,setCreateTaskProgress:b,setGenerateProgress:U,setDownloadProgress:y,setTaskFailedReason:R,setTaskFailedModalVisible:I,setState:k,getState:M,setStatus:P,setTaskId:L}=m;p(100),b(100),U(Math.min(Math.round(g/180*100),99)),y(0);let F=h?"full":"preview",x="preview"===F;w(!0),k({hdType:F});let j=localStorage.getItem("zustand_from_download")===String(!0),C=!j&&"full"===F;k({stopTag:!1}),j?k({downloadLoading:!0}):k({status:x?f.qb.GeneratingPreview:f.qb.GeneratingFull}),k({loading:!0}),x?L(r):k({hasPay:!0}),k({preDownLoadType:C?"".concat(M().downloadType,"_").concat(F,"_lock"):"".concat(M().downloadType,"_").concat(F)}),t({originalPreviewUrl:j?d:""}),k({transparentResiltUrl:x?"":c}),k({taskInfo:e,taskId:r});let E=new a.f({history:e,pendingApi:t=>(0,n.ZJ)(t),needStop:()=>M().stopTag,continueCondition:(t,e)=>(U(Math.min(2e3*e/v.u.getState().taskInfo.waitTime*100,99)),x)?0===t.data.status_preview:0===t.data.status}),O=x?"free":"hd",{actionCreateTask:T,actionGenerateResult:q,actionDownloadResult:D}=i.m3.getState();return E.continueHistory().then(e=>{if(e&&e.data){let r=e.data,{status:a,videoUrl:i,video_preview_url:n,status_preview:s,originalVideoPreViewUrl:o}=r,l=t=>{R(_.ag.t("error_task_error")),I(!0),w(!1),q(!1,"history_result_status_".concat(t,"_error"),O),k({status:f.qb.Default,loading:!1,downloadLoading:!1})};if(w(!1),U(100),"preview"===F){if(1===s)return q(!0,"",O),t({originalPreviewUrl:o}),k({resultUrl:n,transparentResiltUrl:n,status:f.qb.Preview}),C&&k({transparentResiltUrl:n}),t({showResult:!0}),k({isHandled:!0}),n;l(s)}else{if(1===a)return q(!0,"",O),M().status!==f.qb.NoPreviewCount&&k({status:f.qb.Full}),k({hasPay:!0,resultUrl:n,fullResultUrl:i}),C?(k({transparentResiltUrl:i,unlock:!0}),t({originalPreviewUrl:""})):(k({transparentResiltUrl:n}),t({originalPreviewUrl:o})),S.Z.getState().getUserCredits(),i;l(a)}}else q(!1,"history_result_gen_error:code:".concat(null==e?void 0:e.code,":msg:").concat(null==e?void 0:e.msg),O)}).catch(t=>{q(!1,"history_result_loop_error:".concat(t),O),t===a.g.timeout?(R(_.ag.t("generating_task_timeout")),I(!0)):t===a.g.networkError&&(R(_.ag.t("network_error")),I(!0)),w(!1);let{status:e}=M();e===f.qb.GeneratingPreview?P(f.qb.Default):e===f.qb.GeneratingFull&&P(f.qb.Preview),j&&D({action_type:O,is_success:!1,fail_reason:i.z5.GENERATE_ERROE})}).finally(()=>{setTimeout(()=>{k({loading:!1,downloadLoading:!1})},500)})},loadImageMask:async(t,e)=>t.uploadUrl?(0,o.Rn)(t.uploadUrl).then(async r=>{let a=(0,o.vL)(r.width,r.height),i=a.getContext("2d");i.drawImage(r,0,0,r.width,r.height);let n=i.getImageData(0,0,a.width,a.height),s=n.data.buffer,l=await (0,o.GZ)(s,[255,255,255,255],[96,33,255,255]),u=await (0,o.Xu)(l,[0,0,0,0]),d=new ImageData(new Uint8ClampedArray(u),a.width,a.height);null==i||i.putImageData(d,0,0),t.history.addToHistory({time:1e3*t.frameStart/e,canvas:a})}):Promise.resolve()}));window.useObjectRemoverStore=I,(0,U.y)("useObjectRemoverStore",I);var k=I},64669:function(t,e,r){r.d(e,{C9:function(){return d},GZ:function(){return i},Rn:function(){return u},Xu:function(){return n},YQ:function(){return m},Zo:function(){return g},_c:function(){return s},dH:function(){return c},dN:function(){return h},hN:function(){return o},qC:function(){return f},vL:function(){return l}});var a=r(98894);function i(t,e,r){return new Promise((i,n)=>{let s=(0,a.bP)("js","pure.worker.js");fetch(s).then(t=>t.text()).then(a=>{let s=URL.createObjectURL(new Blob([a],{type:"text/javascript"})),o=new Worker(s);o.postMessage({data:t,type:"makeTransparentRgb",from:e,to:r}),o.onmessage=t=>{i(t.data),o.terminate()},o.onerror=t=>{n(t)}})})}function n(t,e){return new Promise((r,i)=>{let n=(0,a.bP)("js","pure.worker.js");fetch(n).then(t=>t.text()).then(a=>{let n=URL.createObjectURL(new Blob([a],{type:"text/javascript"})),s=new Worker(n);s.postMessage({data:t,type:"pureDataRgba2",to:e}),s.onmessage=t=>{r(t.data),s.terminate()},s.onerror=t=>{i(t)}})})}function s(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"image/png";return new Promise((r,a)=>{t.toBlob(t=>{t?r(t):a(Error("blob is null"))},e)})}async function o(t){var e;let r=function(t,e){let r=t.width,a=t.height,i=r>a,n=(i?r:a)/e;if(n<=1){let e=l(t.width,t.height),r=e.getContext("2d");return r.drawImage(t,0,0,t.width,t.height),e}let s=i?e:Math.floor(r/n),o=i?Math.floor(a/n):e,u=l(s,o),d=u.getContext("2d");return d.drawImage(t,0,0,s,o),u}(t,1024),i=r.getContext("2d"),n=i.getImageData(0,0,r.width,r.height),o=n.data.buffer,u=await (e=[255,255,255,255],new Promise((t,r)=>{let i=(0,a.bP)("js","pure.worker.js");fetch(i).then(t=>t.text()).then(a=>{let i=URL.createObjectURL(new Blob([a],{type:"text/javascript"})),n=new Worker(i);n.postMessage({data:o,type:"pureData",to:e}),n.onmessage=e=>{t(e.data),n.terminate()},n.onerror=t=>{r(t)}})})),d=new ImageData(new Uint8ClampedArray(u),r.width,r.height);i&&(i.fillStyle="rgb(0,0,0)",i.fillRect(0,0,r.width,r.height));let h=l(r.width,r.height),c=h.getContext("2d");return c.putImageData(d,0,0),null==i||i.drawImage(h,0,0,r.width,r.height),s(r)}function l(t,e){let r=document.createElement("canvas");return r.width=t,r.height=e,r}function u(t){return new Promise((e,r)=>{let a=new Image;a.src=t,a.crossOrigin="anonymous",a.onload=()=>{e(a)},a.onerror=t=>{r(t)}})}function d(t){var e=l(t.width,t.height);return t.toDataURL()==e.toDataURL()}function h(t){let e=l(t.width,t.height),r=e.getContext("2d");return r.drawImage(t,0,0),e}async function c(t,e,r){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=await u(t);if(a>0){let{width:t,height:n}=g(e,r,a),o=l(t,n),u=o.getContext("2d");return u&&(u.rotate(a*Math.PI/180),u.translate(0,-o.width),u.drawImage(i,0,0,e,r),u.restore()),s(o,"image/jpeg")}let n=l(e,r),o=n.getContext("2d");return o.drawImage(i,0,0,e,r),s(n,"image/jpeg")}function g(t,e,r){return r>0&&(r>45&&r<=135||r>225&&r<=315)?{width:e,height:t}:{width:t,height:e}}function f(t,e,r){let a=r/Math.max(t,e),i=Math.round(t*a),n=Math.round(e*a);return i%2!=0&&(i+=1),n%2!=0&&(n+=1),{width:i,height:n}}function m(t,e,r){let a=l(e,r),i=a.getContext("2d");return i.drawImage(t,0,0,e,r),a}}}]);